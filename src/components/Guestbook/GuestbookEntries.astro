---
import { db, desc, eq, Guestbook as GuestbookDB, isNull, or } from "astro:db";

import Notecard from "../Notecard/Notecard.astro";

const currentPage = Number(Astro.props.currentPage) || 1;
const baseEntriesPerPage = 24;
const entriesPerPage =
  currentPage === 1 ? baseEntriesPerPage - 1 : baseEntriesPerPage;
const isFirstPage = currentPage === 1;
const offset = isFirstPage ? 0 : (currentPage - 1) * baseEntriesPerPage - 1;

const guestbook = await db
  .select()
  .from(GuestbookDB)
  .where(or(eq(GuestbookDB.isSpam, false), isNull(GuestbookDB.isSpam)))
  .orderBy(desc(GuestbookDB.timestamp))
  .limit(entriesPerPage)
  .offset(offset);
---

{
  guestbook.map(({ author, url, content, timestamp, theme }) => (
    <Notecard
      author={author}
      url={url}
      content={content}
      timestamp={timestamp}
      theme={theme}
    />
  ))
}
